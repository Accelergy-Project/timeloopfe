<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Project: About</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">My Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">About </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>timeloopfe is a Python front-end interface to the Timeloop infrastructure, which allows users to model tensor accelerators and explore the vast space of architectures, workloads, and mappings.</p>
<p>Over the original Timeloop infrastructure, timeloopfe provides a richer interface with a newly-designed architecture speficiation, processing / automation tools, and a Python interface. The new interface also includes rigorous type-checking and is fully extensible.</p>
<h1><a class="anchor" id="autotoc_md2"></a>
Examples</h1>
<p>The <code>examples</code> directory contains examples of architecture specifications written in the new format. There are three files of interest in most examples:</p><ul>
<li><code>arch.yaml</code> contains the architecture specification.</li>
<li><code>arch_split.yaml</code> contains the architecture specification, with constraints separated into a separate list. The specification is agnostic to whether constraints are specified in the object they constrain or in a separate list.</li>
<li><code>arch_old.yaml</code> contains the architecture specification in the old Timeloop format. This is provided for comparison.</li>
</ul>
<h2><a class="anchor" id="autotoc_md3"></a>
Running the Example Script</h2>
<p>Any of the example architectures can be run by calling </p><div class="fragment"><div class="line">python3 example.py &lt;example number&gt;</div>
</div><!-- fragment --><p> where <code>&lt;example number&gt;</code> is the number of the example. A full list of examples can be shown by running <code>python3 example.py -h</code>.</p>
<h2><a class="anchor" id="autotoc_md4"></a>
Learning the for Experienced Timeloop Users</h2>
<p>The specification format is designed to be easy to learn for experienced Timeloop users. Explore the <code>examples</code> for examples of architectures written in the old and new formats.</p>
<h1><a class="anchor" id="autotoc_md5"></a>
Using timeloopfe</h1>
<p>There are three steps to using Timeloop with timeloopfe:</p><ol type="1">
<li>Create a specification. This can be done by loading a YAML file, creating a specification from Python objects, or a combination of the two.</li>
<li>Process the specification. This calls a series of processors that apply changes to the specification. A standard suite of processors is provided in <div class="fragment"><div class="line"> {timeloopfe.processors.v4_standard_suite```,}</div>
<div class="line">   created by subclassing ```timeloopfe.processors.Processor```.</div>
<div class="line">3. Call Timeloop. Timeloop model or mapper can be called with the processed</div>
<div class="line">   specification.</div>
<div class="line"> </div>
<div class="line">A full example is shown below:</div>
<div class="line"> </div>
<div class="line">```python</div>
<div class="line">import timeloopfe as tl</div>
<div class="line">from timeloopfe.v4spec.specification import Specification</div>
<div class="line">from timeloopfe.processors.v4_standard_suite import STANDARD_SUITE</div>
<div class="line"> </div>
<div class="line"># Load a specification from a YAML file</div>
<div class="line">spec = Specification.from_yaml_files(</div>
<div class="line">    [&quot;A.yaml&quot;, &quot;B.yaml&quot;]</div>
<div class="line">    processors=STANDARD_SUITE</div>
<div class="line">)</div>
<div class="line"> </div>
<div class="line">spec.process()</div>
<div class="line">tl.model(spec, &#39;./outputsdir&#39;) # or tl.mapper or tl.accelergy</div>
</div><!-- fragment --></li>
</ol>
<p>To run Timeloop using the old specification, use the following: </p><div class="fragment"><div class="line">import timeloopfe as tl</div>
<div class="line">from timeloopfe.v3spec.specification import Specification</div>
<div class="line">from timeloopfe.processors.v3_standard_suite import STANDARD_SUITE</div>
<div class="line"> </div>
<div class="line"># Load a specification from a YAML file</div>
<div class="line">spec = Specification.from_yaml_files(</div>
<div class="line">    [&quot;A.yaml&quot;, &quot;B.yaml&quot;]</div>
<div class="line">    processors=STANDARD_SUITE</div>
<div class="line">)</div>
<div class="line"> </div>
<div class="line">tl.model(spec, &#39;./outputsdir&#39;) # or tl.mapper or tl.accelergy</div>
<div class="line"># use tl.model(spec, &#39;./outputsdir&#39;, legacy_timeloop=True) to use the old</div>
<div class="line"># keywords (mix of dashes and underscores, synonyms)</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md6"></a>
Step 1: Creating a Specification</h2>
<p>The top-level Specification object is the root of the specification. It is a dictionary of objects, each of which contains another input to Timeloop. Specifications can be loaded from YAML files or created from Python objects. The <code>Specification.from_yaml_files</code> method is the YAML entry point, which takes a list of YAML files as input. Each YAML file should contain a dictionary at the top level. Keyword arguments can express additional top-level objects.</p>
<p>When the specification is initialized, sub-objects are hierarchically initialized.</p>
<p>YAML files are structured as nested lists and maps (dictionaries). These will be converted into Python objects. Keys and tags are to determine the structure of YAML input files. Most maps have a set of expected keys, where each key has an expected value type. Likewise, most lists have a set of expected tags, where each tag has an expected value type. The parser will raise an error if a key or tag is missing or unknown.</p>
<div class="fragment"><div class="line"># EXAMPLE:</div>
<div class="line">#    The specification expects a top_level_dict with two keys: key1 and key2.</div>
<div class="line">#    Key1 is a str, and key2 is a list. The list expects two tags: !A and !B.</div>
<div class="line">#    !A is a str, and !B is an int.</div>
<div class="line"> </div>
<div class="line">top_level_dict: # Specification says key1 is a str and key2 is a list</div>
<div class="line">  key1: value1</div>
<div class="line">  key2:</div>
<div class="line">    - !A # Tag !A tells the parser to expect a str</div>
<div class="line">      abc</div>
<div class="line">    - !B # Tag !B tells the parser to expect an int</div>
<div class="line">      123</div>
</div><!-- fragment --><p>All keys and tags are context-dependent. A tree of expected keys, tags, and types can be shown by running the following: </p><div class="fragment"><div class="line">from timeloopfe.v4spec.specification import Specification</div>
<div class="line">from timeloopfe.parsing.doc import get_property_tree</div>
<div class="line">print(get_property_tree(Specification))</div>
</div><!-- fragment --><p>Common sources of errors may be:</p><ul>
<li>An unexpected type (e.g., string where an integer is expected)</li>
<li>A missing key or tag</li>
<li>An unknown key or tag</li>
</ul>
<h2><a class="anchor" id="autotoc_md7"></a>
Step 2: Processing the Specification</h2>
<p>The specification can be processed by calling the <code>process</code> method, which sequentially calls the list of processors provided to the <code>Specification</code> constructor. The <code>STANDARD_SUITE</code> is a list of processors that are recommended.</p>
<p>Of course, the specification can be edited directly instead of via processors. However, processors are useful for portability.</p>
<p>Numerous methods are available to help crawl &amp; process the specification. We recommend looking through the example processors in the </p><div class="fragment"><div class="line"> {timeloopfe.processors.v4_standard_suite```}</div>
<div class="line"> </div>
<div class="line">#### Creating Your Own Processors</div>
<div class="line">To write your own processors, you may subclass</div>
<div class="line">```timeloopfe.processors.Processor```. Processors are given a logger object and</div>
<div class="line">the specification to process. Each edits the specification in-place. Look at</div>
<div class="line">any of the processors in the ```timeloopfe.processors.v4_standard_suite</div>
</div><!-- fragment --><p> module for examples. The </p><div class="fragment"><div class="line"> {timeloopfe/processors/v4suite/constraint_attacher.py```}</div>
<div class="line">point; it contains a simple example of a processor that attaches constraints to</div>
<div class="line"> </div>
<div class="line">Processors may define extra keys or tags that they use in the architecture</div>
<div class="line">specification. They may do so in their init_elems method, which is called</div>
<div class="line">before parsing begins. For example, code below shows a simple processor. The</div>
<div class="line">```SimpleProcessor``` class defines defines a key ```simple_processor_attr</div>
</div><!-- fragment --><p> for the Problem class. The value under the key is a string with a default value of "". As this key is not natively supported, it should be removed by the </p><div class="fragment"><div class="line"> {SimpleProcessor```}</div>
<div class="line">```SimpleProcessor``` does not remove the key, an error will be raised.</div>
<div class="line"> </div>
<div class="line">```python</div>
<div class="line">from timeloopfe.v4spec.problem import Problem</div>
<div class="line"> </div>
<div class="line">class SimpleProcessor(Processor):</div>
<div class="line">    &quot;&quot;&quot;!@brief An example simple processor.&quot;&quot;&quot;</div>
<div class="line"> </div>
<div class="line">    def __init__(self, *args, **kwargs):</div>
<div class="line">        super().__init__(*args, **kwargs)</div>
<div class="line">        self.logger.info(&quot;Initializing SimpleProcessor&quot;)</div>
<div class="line"> </div>
<div class="line">    def init_elems(self):</div>
<div class="line">        &quot;&quot;&quot;!@brief Initialize the elements that the processor handles.&quot;&quot;&quot;</div>
<div class="line">        with self.responsible_for_removing_elems():</div>
<div class="line">            Problem.init_elem(&quot;simple_processor_attr&quot;, str, &quot;&quot;)</div>
<div class="line"> </div>
<div class="line">    def process(self):</div>
<div class="line">        &quot;&quot;&quot;!@brief Process the specification. Remove elements that this</div>
<div class="line">        processor is responsible for.&quot;&quot;&quot;</div>
<div class="line">        if &quot;simple_processor_attr&quot; in self.spec.problem:</div>
<div class="line">            del self.spec.problem[&quot;simple_processor_attr&quot;]</div>
<div class="line">            self.logger.info(&#39;Deleted &quot;simple_processor_attr&quot;&#39;)</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md8"></a>
Step 3: Calling Timeloop</h2>
<p>Timeloop is called by the <code>timeloopfe.model</code> and <code>timeloopfe.model</code> functions. Accelergy verbose can be called with <code>timeloopfe.accelergy</code>. These functions are called using the following interface:</p>
<div class="fragment"><div class="line">def call_timeloop-mapper(</div>
<div class="line">    specification: &quot;Specification&quot;,</div>
<div class="line">    output_dir: str,</div>
<div class="line">    environment: Optional[Dict[str, str]] = None,</div>
<div class="line">    extra_input_files: Optional[List[str]] = None,</div>
<div class="line">    dump_intermediate_to: Optional[str] = None,</div>
<div class="line">    log_to: Optional[Union[str, IO]] = None,</div>
<div class="line">    legacy_timeloop: bool = False,</div>
<div class="line">) -&gt; int:</div>
<div class="line">    &quot;&quot;&quot;!@brief Call Timeloop Mapper from Python</div>
<div class="line">    !@param specification The specification with which to call Timeloop.</div>
<div class="line">    !@param input_content The content of the input file.</div>
<div class="line">    !@param output_dir The directory to run Timeloop in.</div>
<div class="line">    !@param environment A dictionary of environment variables to pass to</div>
<div class="line">                        Timeloop.</div>
<div class="line">    !@param extra_input_files A list of extra input files to pass to Timeloop.</div>
<div class="line">    !@param dump_intermediate_to If not None, dump the input content to this</div>
<div class="line">                                 file before calling Timeloop.</div>
<div class="line">    !@param log_to If not None, log the output of the Timeloop call to this</div>
<div class="line">                   file or file-like object.</div>
<div class="line">    !@param legacy_timeloop If True, use the legacy Timeloop command.</div>
<div class="line">    !@return The return code of the Timeloop call.</div>
<div class="line">    &quot;&quot;&quot;</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md9"></a>
New v4 Architecture Specification</h1>
<p>Check out the <code>examples</code> directory for examples of architecture specifications.</p>
<p>The architecture is composed of leaf and branch nodes. Leaf nodes represent objects in the architecture, while branch nodes represent the organization of other nodes. Branches can be nested.</p>
<h2><a class="anchor" id="autotoc_md10"></a>
Leaf Nodes</h2>
<p>Leaf nodes denote the objects within an architecture.</p>
<p>Leaf objects are denoted in the following way: </p><div class="fragment"><div class="line">- !&lt;LEAF_NOUN&gt;</div>
<div class="line">  attributes: {Dictionary of attributes}</div>
<div class="line">  spatial: {meshX: &lt;int&gt;, meshY: &lt;int&gt;}</div>
<div class="line">  constraints: {Dictionary of constraints}</div>
</div><!-- fragment --><p>The following types of leaves are supported. Notice that <em>the name of each leaf is a noun describing the type of leaf</em></p><ul>
<li><code>!Element</code> objects include storage and compute units.</li>
<li><code>!Container</code> objects encompass other objects. They can be used to group objects together for the purpose of applying constraints or attributes to them.</li>
<li><code>!Nothing</code> objects are represent empty space or a lack of node in a location. For example, a <code>!Nothing</code> node may be used in a <code>!Parallel</code> branch to process data that skips all other nodes in the branch.</li>
</ul>
<h2><a class="anchor" id="autotoc_md11"></a>
Branch Nodes</h2>
<p>Branch nodes denote the organization of nodes in an architecture. Each branch is a collection of nodes that are related to each other in some way. Branches can be nested to any depth.</p>
<p>Branch objects are denoted in the following way: </p><div class="fragment"><div class="line">- !&lt;BRANCHTYPE_ADJECTIVE&gt;</div>
<div class="line">  nodes: [List of nodes in this branch]</div>
</div><!-- fragment --><p>The following types of branches are supported. Notice that <em>the name of each branch is an adjective describing the relations between the nodes it contains:</em></p><ul>
<li><code>!Hierarchical</code> nodes can move data between nodes that are lower/higher in the hierarchy. Nodes lower in the hierarchy (further from main memory) can use higher-level nodes as backing memory.</li>
<li><code>!Pipelined</code> nodes can not move data flexibly; each piece of data entering one end of the pipeline will exit the other end.</li>
<li><code>!Parallel</code> nodes process disjoint sets of data in parallel. Each dataspace traversing the parallel branch must traverse exactly one of the nodes within the branch.</li>
</ul>
<h2><a class="anchor" id="autotoc_md12"></a>
Expressing Spatial Fanout</h2>
<p>Spatial fanout is expressed by adding a <code>spatial</code> attribute to a leaf node. Under a hierarchy, this spatial fanout will be applied to all subsequent nodes in the hierarchy. Multiple spatial fanouts in a hierarchy will be multiplied together.</p>
<p>Spatial constraints are applied "between" the spatial elements in a fanout. For example, consider the following:</p>
<div class="fragment"><div class="line">nodes: # Top-level hierarchy</div>
<div class="line">- !Container</div>
<div class="line">  name: top</div>
<div class="line"> </div>
<div class="line">- !Container # PE</div>
<div class="line">  name: PE</div>
<div class="line">  spatial: {meshY: 12}</div>
<div class="line">  constraints:</div>
<div class="line">    spatial: {factors: [P=12]}</div>
<div class="line"> </div>
<div class="line">- !Element # Storage</div>
<div class="line">  name: spad</div>
<div class="line">  class: storage</div>
<div class="line">  attributes: {Omitted for brevity}</div>
<div class="line"> </div>
<div class="line">- !Element # MAC unit</div>
<div class="line">  name: mac</div>
<div class="line">  class: intmac</div>
<div class="line">  attributes: {Omitted for brevity}</div>
</div><!-- fragment --><p>In this example, there are 12 PEs in the Y dimension of the array. Each PE has a scratchpad and a MAC unit. A spatial factor of <code>P=12</code> is applied to the PEs, meaning that each PE will process a different index of the <code>P</code> dimension of workload tensors.</p>
<p>Spatial fanouts are not allowed under pipeline or parallel branches.</p>
<h2><a class="anchor" id="autotoc_md13"></a>
A Full Example</h2>
<p>Below is the full specification of the Eyeriss architecture. Eyeriss has a DRAM main memory, a global buffer for inputs and outputs, and a 2D array of processing elements (PEs). Each PE has three parallel scratchpads to store inputs, weights, and outputs. Each PE also has a MAC unit to perform computations.</p>
<p>Containers are used to group the PEs together into a 2D array. We use two levels of container to represent different spatial constraints for the X and Y dimensions of the array.</p>
<p>A mix of block and flow style YAML is used. In general, flow style is used for short lists / maps that can fit in a single line, while block style is used for everything else.</p>
<div class="fragment"><div class="line">architecture:</div>
<div class="line">  # ============================================================</div>
<div class="line">  # Architecture Description</div>
<div class="line">  # ============================================================</div>
<div class="line">  version: 0.4</div>
<div class="line">  nodes: # Top-level is hierarchical</div>
<div class="line">  - !Element # DRAM main memory</div>
<div class="line">    name: DRAM</div>
<div class="line">    class: DRAM</div>
<div class="line">    attributes: {type: &quot;LPDDR4&quot;, width: 64, block_size: 8, datawidth: 8}</div>
<div class="line"> </div>
<div class="line">  - !Container # Eyeriss accelerator</div>
<div class="line">    name: eyeriss</div>
<div class="line">    attributes: {technology: &quot;32nm&quot;}</div>
<div class="line">      </div>
<div class="line">  - !Element # Global buffer for inputs &amp; outputs</div>
<div class="line">    name: shared_glb</div>
<div class="line">    class: smartbuffer_SRAM</div>
<div class="line">    attributes:</div>
<div class="line">      memory_depth: 16384</div>
<div class="line">      memory_width: 64</div>
<div class="line">      n_banks: 32</div>
<div class="line">      block_size: 8</div>
<div class="line">      datawidth: 8</div>
<div class="line">      read_bandwidth: 16</div>
<div class="line">      write_bandwidth: 16</div>
<div class="line">    constraints:</div>
<div class="line">      dataspace: {keep: [Inputs, Outputs], bypass: [Weights]}</div>
<div class="line"> </div>
<div class="line">  - !Container # Each column of PEs produces a different psum row</div>
<div class="line">    name: PE_column</div>
<div class="line">    spatial: {meshX: 14}</div>
<div class="line">    constraints:</div>
<div class="line">      spatial:</div>
<div class="line">        permutation: [N, C, P, R, S, Q, M]</div>
<div class="line">        factors: [N=1, C=1, P=1, R=1, S=1]</div>
<div class="line">        split: 7</div>
<div class="line"> </div>
<div class="line">  - !Container # Each PE in the column receives a different filter row</div>
<div class="line">    name: PE</div>
<div class="line">    spatial: {meshY: 12}</div>
<div class="line">    constraints:</div>
<div class="line">      spatial:</div>
<div class="line">        split: 4</div>
<div class="line">        permutation: [N, P, Q, R, S, C, M]</div>
<div class="line">        factors: [N=1, P=1, Q=1, R=1]</div>
<div class="line"> </div>
<div class="line">  - !Parallel # Input/Output/Weight scratchpads in parallel</div>
<div class="line">    nodes:</div>
<div class="line">    - !Element # Input scratchpad</div>
<div class="line">      name: ifmap_spad</div>
<div class="line">      class: smartbuffer_RF</div>
<div class="line">      attributes: {memory_depth: 12, memory_width: 16, datawidth: 8}</div>
<div class="line">      constraints:</div>
<div class="line">        dataspace: {keep: [Inputs]}</div>
<div class="line">        temporal:</div>
<div class="line">          permutation: [N, M, C, P, Q, R, S]</div>
<div class="line">          factors: [N=1, M=1, C=1, P=1, Q=1, R=1, S=1]</div>
<div class="line"> </div>
<div class="line">    - !Element # Weight scratchpad</div>
<div class="line">      name: weights_spad</div>
<div class="line">      class: smartbuffer_RF</div>
<div class="line">      attributes: {memory_depth: 192, memory_width: 16, datawidth: 8}</div>
<div class="line">      constraints:</div>
<div class="line">        dataspace: {keep: [Weights]}</div>
<div class="line">        temporal: {factors: [N=1, M=1, P=1, Q=1, S=1]}</div>
<div class="line"> </div>
<div class="line">    - !Element # Output scratchpad</div>
<div class="line">      name: psum_spad</div>
<div class="line">      class: smartbuffer_RF</div>
<div class="line">      attributes: </div>
<div class="line">        memory_depth: 16</div>
<div class="line">        memory_width: 16</div>
<div class="line">        datawidth: 16</div>
<div class="line">        update_fifo_depth: 2</div>
<div class="line">      constraints:</div>
<div class="line">        dataspace: {keep: [Outputs]}</div>
<div class="line">        temporal: {factors: [N=1, C=1, R=1, S=1, P=1, Q=1]}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  - !Element # MAC unit</div>
<div class="line">    name: mac</div>
<div class="line">    class: intmac</div>
<div class="line">    attributes: {multiplier_width: 8, adder_width: 16}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md14"></a>
Other Inputs</h2>
<p>Other inputs (e.g., constraints, mapper, sparse_optimizations) largely follow the same format as existing Timeloop inputs. See the Timeloop documentation for more information, or use the following commands to see the full structure of all inputs: ```python from timeloopfe.v4spec.specification import Specification from timeloopfe.parsing.doc import get_property_tree print(get_property_tree(Specification)) </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
